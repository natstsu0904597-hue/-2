<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚„ã•ã—ã„é£Ÿäº‹ã‚µãƒãƒ¼ãƒˆï¼ˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ«å‘ã‘ï¼‰</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f3fbff;
      --card:#ffffffcc;
      --text:#243042;
      --muted:#6b778c;
      --line:#e9e5f0;
      --accent:#7aa7ff;
      --accent2:#ff9db8;
      --ok:#38b77a;
      --warn:#f3a63b;
      --shadow: 0 10px 30px rgba(31, 41, 55, .10);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(255,157,184,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(122,167,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:22px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      display:grid;
      gap:16px;
      grid-template-columns: 1.15fr .85fr;
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; padding-bottom:32px;}
    }

    header{
      grid-column: 1 / -1;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding:10px 6px;
    }

    .brand h1{
      margin:0;
      font-size:20px;
      letter-spacing:.02em;
    }
    .brand p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      border-radius:999px;
      box-shadow: 0 6px 20px rgba(31, 41, 55, .06);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .card .hd{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(233,229,240,.8);
    }
    .hd h2{
      margin:0;
      font-size:16px;
    }
    .hd small{
      color:var(--muted);
      font-size:12px;
    }

    .card .bd{
      padding:14px 16px 16px;
    }

    .grid{display:grid; gap:12px;}

    .goals{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 520px){
      .goals{grid-template-columns: 1fr;}
    }

    .goal{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.72);
      border-radius:16px;
      padding:14px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      position:relative;
      outline:none;
    }
    .goal:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(31,41,55,.10);
      border-color: rgba(122,167,255,.45);
    }
    .goal[aria-checked="true"]{
      border-color: rgba(122,167,255,.9);
      box-shadow: 0 16px 50px rgba(122,167,255,.12);
    }
    .goal .icon{
      width:38px; height:38px;
      border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(122,167,255,.25), rgba(255,157,184,.22));
      border:1px solid rgba(233,229,240,.9);
      flex:0 0 auto;
      font-size:18px;
    }
    .goal .t{
      margin:0;
      font-weight:700;
      font-size:14px;
      line-height:1.35;
    }
    .goal .d{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .goal .check{
      position:absolute;
      top:10px; right:10px;
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid rgba(233,229,240,.9);
      background:rgba(255,255,255,.75);
      display:grid; place-items:center;
      font-size:13px;
      color:transparent;
      transition: .12s ease;
    }
    .goal[aria-checked="true"] .check{
      color:#fff;
      border-color: rgba(122,167,255,.95);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
    }

    .row{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 520px){
      .row{grid-template-columns: 1fr;}
    }

    .field{display:grid; gap:6px;}
    label{font-size:12px; color:var(--muted);}

    input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.82);
      outline:none;
      font-size:14px;
      color:var(--text);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus, select:focus{
      border-color: rgba(122,167,255,.9);
      box-shadow: 0 0 0 4px rgba(122,167,255,.14);
    }

    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      color:var(--text);
      font-size:13px;
      transition:.12s ease;
      display:inline-flex;
      align-items:center;
      gap:7px;
    }
    .seg button:hover{ transform: translateY(-1px); }
    .seg button[aria-pressed="true"]{
      border-color: rgba(122,167,255,.9);
      box-shadow: 0 10px 30px rgba(122,167,255,.12);
      background: linear-gradient(135deg, rgba(122,167,255,.20), rgba(255,157,184,.16));
    }

    .photoBox{
      display:grid;
      gap:10px;
      border:1px dashed rgba(122,167,255,.55);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.55);
    }
    .photoTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .preview{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .thumb{
      width:72px; height:72px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.65);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .thumb .ph{color:var(--muted);font-size:12px;}

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      padding-top:8px;
    }

    .btn{
      border:none;
      padding:12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); opacity:.95; }

    .btn.primary{
      color:white;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 16px 50px rgba(122,167,255,.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,.72);
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn.small{
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      font-weight:650;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.65;
      margin:10px 0 0;
    }

    .result{display:grid; gap:12px;}

    .kpi{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 520px){
      .kpi{grid-template-columns: 1fr;}
    }

    .k{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(255,255,255,.75);
    }
    .k .lab{font-size:12px;color:var(--muted);}
    .k .val{margin-top:6px;font-size:18px;font-weight:800;letter-spacing:.01em;}
    .k .sub{margin-top:2px;font-size:12px;color:var(--muted);}

    .bubble{
      border:1px solid var(--line);
      border-radius: 18px;
      padding:14px 14px;
      background: rgba(255,255,255,.78);
    }
    .bubble h3{margin:0 0 8px;font-size:14px;}
    .bubble ul{margin:0;padding-left:18px;line-height:1.75;font-size:13px;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.70);
      color:var(--muted);
    }
    .statusDot{width:10px;height:10px;border-radius:999px;background: var(--warn);}

    .log{
      border-top:1px dashed rgba(233,229,240,.9);
      margin-top:10px;
      padding-top:10px;
      display:grid;
      gap:8px;
    }
    .entry{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.70);
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .entry .meta{display:grid;gap:2px;}
    .entry .meta strong{font-size:13px;}
    .entry .meta span{font-size:12px;color:var(--muted);}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.76);
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>ã‚„ã•ã—ã„é£Ÿäº‹ã‚µãƒãƒ¼ãƒˆ</h1>
        <p>ç›®æ¨™ã‚’é¸ã¶ã ã‘ã§ã€ä»Šæ—¥ã®é£Ÿäº‹ã®â€œæ¬¡ã«ã‚„ã‚‹ã“ã¨â€ãŒæ±ºã¾ã‚‹ã€‚ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å‘ã‘ãƒ»ä¼šå“¡å‘ã‘ã©ã¡ã‚‰ã§ã‚‚ä½¿ãˆã‚‹ãƒŸãƒ‹ç®¡ç†ã‚¢ãƒ—ãƒªã€‚</p>
      </div>
      <div class="chip" id="todayChip">ğŸ—“ï¸ ä»Šæ—¥ï¼šâ€”</div>
    </header>

    <section class="card">
      <div class="hd">
        <div>
          <h2>1) ç›®æ¨™ã‚’é¸ã¶</h2>
          <small>æœ€åˆã«1ã¤ã ã‘ã€‚è¿·ã‚ã›ãªã„è¨­è¨ˆã€‚</small>
        </div>
        <span class="badge"><span class="statusDot" id="goalDot"></span><span id="goalStatus">æœªé¸æŠ</span></span>
      </div>

      <div class="bd grid">
        <div class="goals" id="goalGrid" role="radiogroup" aria-label="ç›®æ¨™é¸æŠ"></div>

        <div class="card" style="box-shadow:none; border-radius:16px; background:rgba(255,255,255,.55);">
          <div class="hd" style="border-bottom:none;">
            <div>
              <h2 style="font-size:15px;">2) ä»Šæ—¥ã®å…¥åŠ›</h2>
              <small>å†™çœŸ or ã‹ã‚“ãŸã‚“é¸æŠã€‚ç¶šãè¨­è¨ˆã€‚</small>
            </div>
            <button class="btn ghost small" id="resetBtn" type="button">â†º ãƒªã‚»ãƒƒãƒˆ</button>
          </div>

          <div class="bd grid" style="padding-top:0;">
            <div class="row">
              <div class="field">
                <label>é£Ÿäº‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <div class="seg" id="mealSeg">
                  <button type="button" data-meal="æœ" aria-pressed="true">ğŸŒ¤ï¸ æœ</button>
                  <button type="button" data-meal="æ˜¼" aria-pressed="false">â˜€ï¸ æ˜¼</button>
                  <button type="button" data-meal="å¤œ" aria-pressed="false">ğŸŒ™ å¤œ</button>
                  <button type="button" data-meal="é–“é£Ÿ" aria-pressed="false">ğŸª é–“é£Ÿ</button>
                </div>
              </div>

              <div class="field">
                <label>é‡ã®ç›®å®‰ï¼ˆè£œæ­£ï¼‰</label>
                <select id="portion">
                  <option value="0.85">å°‘ãªã‚</option>
                  <option value="1" selected>ãµã¤ã†</option>
                  <option value="1.2">å¤šã‚</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>ã„ã¡ã°ã‚“å›°ã£ã¦ã‚‹ã“ã¨ï¼ˆ1ã¤ï¼‰</label>
              <div class="seg" id="issueSeg">
                <button type="button" data-issue="å¤œã«é£Ÿã¹ã™ãã‚‹" aria-pressed="false">ğŸŒ™ å¤œå¤šã‚</button>
                <button type="button" data-issue="é–“é£ŸãŒæ­¢ã¾ã‚‰ãªã„" aria-pressed="false">ğŸ« é–“é£Ÿå¤šã‚</button>
                <button type="button" data-issue="å¤–é£ŸãŒå¤šã„" aria-pressed="false">ğŸœ å¤–é£Ÿå¤šã‚</button>
                <button type="button" data-issue="æ™‚é–“ãŒãªãã¦é©å½“ã«ãªã‚‹" aria-pressed="false">â±ï¸ æ™‚é–“ãªã„</button>
              </div>
            </div>

            <div class="photoBox">
              <div class="photoTop">
                <div class="preview">
                  <div class="thumb" id="thumb">
                    <div class="ph">å†™çœŸãªã—</div>
                  </div>
                  <div>
                    <div style="font-weight:750; font-size:13px;">é£Ÿäº‹å†™çœŸï¼ˆä»»æ„ï¼‰</div>
                    <small class="muted">â€»ã“ã®HTMLã¯ãƒ‡ãƒ¢ç‰ˆã§ã™ã€‚å†™çœŸã‹ã‚‰ã®è‡ªå‹•æ¨å®šã¯æœªå®Ÿè£…ï¼ˆè¨˜éŒ²ï¼‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆã¾ã§ï¼‰ã€‚</small>
                  </div>
                </div>

                <label class="btn ghost small" style="cursor:pointer;">
                  ğŸ“· ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                  <input id="photo" type="file" accept="image/*" style="display:none;">
                </label>
              </div>

              <div class="row">
                <div class="field">
                  <label>é£Ÿäº‹å†…å®¹ï¼ˆã–ã£ãã‚Šã§OKï¼‰</label>
                  <input id="mealText" type="text" placeholder="ä¾‹ï¼šé¶ã‚€ã­ï¼‹ã‚µãƒ©ãƒ€ï¼‹å‘³å™Œæ±ã€ãƒ‘ã‚¹ã‚¿ã€ã‚³ãƒ³ãƒ“ãƒ‹ãŠã«ãã‚Š ãªã©">
                </div>

                <div class="field">
                  <label>é¸æŠï¼ˆã‚ˆãã‚ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰</label>
                  <select id="quickMenu">
                    <option value="">é¸æŠã—ãªã„</option>
                    <option value="å®šé£Ÿï¼ˆã”ã¯ã‚“ï¼‹ä¸»èœï¼‹å‰¯èœï¼‰">å®šé£Ÿï¼ˆã”ã¯ã‚“ï¼‹ä¸»èœï¼‹å‰¯èœï¼‰</option>
                    <option value="ä¸¼ï¼ˆç‰›ä¸¼ãƒ»è¦ªå­ä¸¼ãªã©ï¼‰">ä¸¼ï¼ˆç‰›ä¸¼ãƒ»è¦ªå­ä¸¼ãªã©ï¼‰</option>
                    <option value="éººï¼ˆãƒ©ãƒ¼ãƒ¡ãƒ³ãƒ»ãƒ‘ã‚¹ã‚¿ãªã©ï¼‰">éººï¼ˆãƒ©ãƒ¼ãƒ¡ãƒ³ãƒ»ãƒ‘ã‚¹ã‚¿ãªã©ï¼‰</option>
                    <option value="ã‚µãƒ©ãƒ€ï¼‹ãŸã‚“ã±ãï¼ˆãƒã‚­ãƒ³ç­‰ï¼‰">ã‚µãƒ©ãƒ€ï¼‹ãŸã‚“ã±ãï¼ˆãƒã‚­ãƒ³ç­‰ï¼‰</option>
                    <option value="ã‚³ãƒ³ãƒ“ãƒ‹ï¼ˆãŠã«ãã‚Šï¼‹ã‚µãƒ©ãƒ€ãƒã‚­ãƒ³ç­‰ï¼‰">ã‚³ãƒ³ãƒ“ãƒ‹ï¼ˆãŠã«ãã‚Šï¼‹ã‚µãƒ©ãƒ€ãƒã‚­ãƒ³ç­‰ï¼‰</option>
                    <option value="é–“é£Ÿï¼ˆè“å­ãƒ»ç”˜ã„é£²ã¿ç‰©ï¼‰">é–“é£Ÿï¼ˆè“å­ãƒ»ç”˜ã„é£²ã¿ç‰©ï¼‰</option>
                  </select>
                </div>
              </div>

              <div class="actions">
                <button class="btn ghost" id="saveBtn" type="button">ğŸ“ è¨˜éŒ²ã™ã‚‹</button>
                <button class="btn primary" id="advBtn" type="button">âœ¨ ä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½œã‚‹</button>
              </div>

              <p class="hint" id="hintText">ç›®æ¨™ã‚’é¸ã¶ â†’ ä»Šæ—¥ã®å…¥åŠ› â†’ ã€Œä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½œã‚‹ã€ã§OKã€‚</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>ä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
          <small>ç›®æ¨™ã«åˆã‚ã›ã¦â€œæ¬¡ã«ã‚„ã‚‹1ã¤â€ã‚’æç¤ºã€‚</small>
        </div>
        <span class="badge"><span class="statusDot" id="advDot"></span><span id="advStatus">æœªç”Ÿæˆ</span></span>
      </div>

      <div class="bd result">
        <div class="kpi">
          <div class="k">
            <div class="lab">é¸æŠä¸­ã®ç›®æ¨™</div>
            <div class="val" id="kGoal">â€”</div>
            <div class="sub" id="kGoalSub">ã¾ãšã¯ç›®æ¨™ã‚’1ã¤é¸ã³ã¾ã—ã‚‡ã†</div>
          </div>
          <div class="k">
            <div class="lab">ä»Šå›ã®é£Ÿäº‹</div>
            <div class="val" id="kMeal">â€”</div>
            <div class="sub" id="kMealSub">ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»é‡ãƒ»å†…å®¹ã‚’å…¥ã‚Œã‚‹ã¨ç²¾åº¦UP</div>
          </div>
        </div>

        <div class="bubble">
          <h3>âœ… è‰¯ã‹ã£ãŸç‚¹</h3>
          <ul id="goodList"><li class="muted">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li></ul>
        </div>

        <div class="bubble">
          <h3>ğŸ¯ æ¬¡ã«ã‚„ã‚‹ã“ã¨ï¼ˆ1ã¤ï¼‰</h3>
          <ul id="nextList"><li class="muted">ç›®æ¨™ã‚’é¸ã‚“ã§ã€Œä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚</li></ul>
        </div>

        <div class="bubble">
          <h3>ğŸ½ï¸ æ¬¡ã®é£Ÿäº‹ã®ææ¡ˆ</h3>
          <ul id="menuList"><li class="muted">ææ¡ˆãŒã“ã“ã«å‡ºã¾ã™ã€‚</li></ul>
        </div>

        <div class="bubble">
          <h3>ğŸ“š ä»Šæ—¥ã®ãƒ­ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</h3>
          <div class="log" id="log"></div>
          <p class="hint">â€»ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ä¿å­˜ã—ã¾ã™ã€‚</p>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const GOALS = [
      { id:"cut",   icon:"ğŸ”¥", title:"ä½“è„‚è‚ªã‚’è½ã¨ã—ã¦å¼•ãç· ã‚ãŸã„", desc:"ç„¡ç†ãªåˆ¶é™ã‚ˆã‚Šã€å¤œã®æ•´ãˆï¼†ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå„ªå…ˆã€‚" },
      { id:"shape", icon:"âœ¨", title:"ä½“é‡ã¯ãã®ã¾ã¾ã§è¦‹ãŸç›®ã‚’æ•´ãˆãŸã„", desc:"PFCã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§â€œæ•´ã†â€æ–¹å‘ã¸ã€‚" },
      { id:"gain",  icon:"ğŸ’ª", title:"ç­‹è‚‰ã‚’ã¤ã‘ã¦ãƒ¡ãƒªãƒãƒªã‚’å‡ºã—ãŸã„", desc:"ä¸è¶³ã•ã›ãªã„ã€‚ãƒˆãƒ¬å‰å¾Œã®é£Ÿäº‹ãŒã‚«ã‚®ã€‚" },
      { id:"energy",icon:"ğŸŒ¿", title:"ç–²ã‚Œã«ãã„ä½“ã«ãªã‚ŠãŸã„", desc:"è¡€ç³–å®‰å®šï¼†é‰„ãƒ»ãƒ“ã‚¿ãƒŸãƒ³ã‚’æ„è­˜ã€‚" },
      { id:"habit", icon:"ğŸ«¶", title:"ãƒªãƒã‚¦ãƒ³ãƒ‰ã—ãªã„ç¿’æ…£ã‚’ä½œã‚ŠãŸã„", desc:"å®Œç’§ã‚’ã‚„ã‚ã¦â€œç¶šãå½¢â€ã«å¯„ã›ã‚‹ã€‚" },
    ];

    const STORAGE_KEY = "gentle_food_support_v1";

    const state = {
      goalId: null,
      mealTime: "æœ",
      portion: 1,
      issue: null,
      mealText: "",
      quickMenu: "",
      photoDataUrl: null,
      logs: []
    };

    const $ = (sel) => document.querySelector(sel);

    function setTodayChip(){
      const d = new Date();
      const s = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      $("#todayChip").textContent = `ğŸ—“ï¸ ä»Šæ—¥ï¼š${s}`;
    }

    function saveStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function loadStorage(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      try{ Object.assign(state, JSON.parse(raw)); }catch(e){ console.warn(e); }
    }

    function goalById(id){ return GOALS.find(g => g.id === id); }

    function niceMealSummary(){
      const base = state.mealText || state.quickMenu || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      const portionLabel = state.portion < 1 ? "å°‘ãªã‚" : (state.portion > 1 ? "å¤šã‚" : "ãµã¤ã†");
      const issue = state.issue ? ` / æ‚©ã¿ï¼š${state.issue}` : "";
      return `${state.mealTime}ãƒ»${portionLabel}ãƒ»${base}${issue}`;
    }

    function renderGoals(){
      const grid = $("#goalGrid");
      grid.innerHTML = "";
      GOALS.forEach(g => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "goal";
        btn.setAttribute("role","radio");
        btn.setAttribute("aria-checked", String(state.goalId === g.id));
        btn.dataset.goalId = g.id;

        btn.innerHTML = `
          <div class="icon">${g.icon}</div>
          <div>
            <p class="t">${g.title}</p>
            <p class="d">${g.desc}</p>
          </div>
          <div class="check">âœ“</div>
        `;

        btn.addEventListener("click", () => {
          state.goalId = g.id;
          renderAll();
          saveStorage();
        });

        grid.appendChild(btn);
      });
    }

    function renderThumb(){
      const thumb = $("#thumb");
      if(state.photoDataUrl){
        thumb.innerHTML = `<img alt="é£Ÿäº‹å†™çœŸ" src="${state.photoDataUrl}">`;
      }else{
        thumb.innerHTML = `<div class="ph">å†™çœŸãªã—</div>`;
      }
    }

    function renderKpis(){
      const g = state.goalId ? goalById(state.goalId) : null;

      $("#kGoal").textContent = g ? g.title : "â€”";
      $("#kGoalSub").textContent = g ? g.desc : "ã¾ãšã¯ç›®æ¨™ã‚’1ã¤é¸ã³ã¾ã—ã‚‡ã†";

      $("#kMeal").textContent = state.mealTime || "â€”";
      $("#kMealSub").textContent = (state.mealText || state.quickMenu) ? niceMealSummary() : "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»é‡ãƒ»å†…å®¹ã‚’å…¥ã‚Œã‚‹ã¨ç²¾åº¦UP";

      const goalOk = !!state.goalId;
      $("#goalDot").style.background = goalOk ? "var(--ok)" : "var(--warn)";
      $("#goalStatus").textContent = goalOk ? "é¸æŠæ¸ˆã¿" : "æœªé¸æŠ";
    }

    function renderSegButtons(containerSel, key){
      const wrap = $(containerSel);
      wrap.querySelectorAll("button").forEach(b => {
        const val = b.dataset[key];
        const pressed = (key === "meal") ? (state.mealTime === val) : (state.issue === val);
        b.setAttribute("aria-pressed", String(pressed));
      });
    }

    function renderLog(){
      const el = $("#log");
      el.innerHTML = "";
      if(!state.logs.length){
        el.innerHTML = `<div class="muted" style="font-size:13px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }
      state.logs.slice().reverse().forEach(item => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <div class="meta">
            <strong>${item.mealTime}ï¼ˆ${item.time}ï¼‰</strong>
            <span>${item.summary}</span>
          </div>
          <span class="pill">${item.goalTitle}</span>
        `;
        el.appendChild(div);
      });
    }

    function buildAdvice(){
      const g = goalById(state.goalId);
      const mealBase = state.mealText || state.quickMenu || "";
      const portion = Number(state.portion || 1);
      const issue = state.issue || "";

      const good = [];
      if(mealBase){
        good.push("è¨˜éŒ²ã§ããŸã®ãŒæœ€é«˜ã€‚ç¶šã‘ã‚‹ã»ã©ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚");
      } else {
        good.push("ä»Šæ—¥ã¯â€œå…¥åŠ›ã ã‘â€ã§ã‚‚OKã€‚ç¿’æ…£åŒ–ãŒã„ã¡ã°ã‚“å¤§äº‹ã€‚");
      }
      if(state.mealTime === "æœ") good.push("æœã«æ„è­˜ãŒå‘ã„ã¦ã„ã‚‹ã®ã¯å¼·ã„ã§ã™ã€‚");
      if(state.mealTime === "å¤œ") good.push("å¤œã‚’æ•´ãˆã‚‹ã¨è¦‹ãŸç›®ãŒå¤‰ã‚ã‚Šã‚„ã™ã„ã§ã™ã€‚");
      if(issue) good.push(`å›°ã‚Šã”ã¨ã‚’1ã¤ã«çµã‚Œã¦ã„ã¾ã™ï¼ˆ${issue}ï¼‰ã€‚`);

      let next = "æ¬¡ã®é£Ÿäº‹ã§ã€ŒãŸã‚“ã±ãè³ªã€ã‚’1å“è¶³ã™ã€‚";
      let menu = [];

      if(g.id === "cut"){
        if(state.mealTime === "å¤œ" || issue.includes("å¤œ")){
          next = "æ¬¡ã®å¤œã¯ã€Œä¸»é£Ÿã‚’åŠåˆ†ã€ï¼‹ã€Œæ±ç‰©ã€ã‚’è¶³ã™ã€‚";
        } else {
          next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œæ‰‹ã®ã²ã‚‰åˆ†ã®ãŸã‚“ã±ãè³ªã€ã‚’æœ€å„ªå…ˆã€‚";
        }
        menu = [
          "é¶ã‚€ã­ or é­š + ã‚µãƒ©ãƒ€ + å‘³å™Œæ±",
          "ã”ã¯ã‚“ã¯å°‘ãªã‚ï¼ˆã¾ãŸã¯åŠåˆ†ï¼‰",
          "é–“é£Ÿã¯ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ/ãƒãƒ¼ã‚º/ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã«ç½®ãæ›ãˆ"
        ];
      }

      if(g.id === "shape"){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œä¸»é£Ÿãƒ»ä¸»èœãƒ»å‰¯èœã€ã‚’ãã‚ãˆã‚‹ã€‚";
        menu = [
          "ã”ã¯ã‚“ + ãŸã‚“ã±ãï¼ˆé­š/åµ/è±†è…ï¼‰ + é‡èœ/ãã®ã“",
          "å¤œã ã‘æ¥µç«¯ã«æŠœã‹ãªã„ï¼ˆã‚€ãã¿ã‚„ã™ããªã‚Šã¾ã™ï¼‰",
          "æ°´åˆ†ï¼‹å¡©åˆ†ãƒãƒ©ãƒ³ã‚¹ï¼šæ±ç‰©ã¯OKã€æ¿ƒã™ãæ³¨æ„"
        ];
      }

      if(g.id === "gain"){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œç‚­æ°´åŒ–ç‰©ï¼‹ãŸã‚“ã±ãè³ªã€ã‚’ã‚»ãƒƒãƒˆã§ã€‚";
        menu = [
          "ãŠã«ãã‚Š + ã‚µãƒ©ãƒ€ãƒã‚­ãƒ³ + ãƒãƒŠãƒŠ",
          "ãƒˆãƒ¬å¾Œï¼šç™½ç±³/ã†ã©ã‚“ + è‚‰/é­š/åµ",
          "ä¸è¶³ã—ãŒã¡ãªã‚‰é–“é£Ÿã«ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ï¼‹æœç‰©"
        ];
      }

      if(g.id === "energy"){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œè¡€ç³–ãŒä¹±ã‚Œã«ãã„çµ„ã¿åˆã‚ã›ã€ã«ã™ã‚‹ã€‚";
        menu = [
          "ä¸»é£Ÿã¯OKï¼šãŸã ã—å…ˆã«æ±ç‰©/é‡èœ â†’ ä¸»èœ â†’ ä¸»é£Ÿ",
          "é‰„ï¼šèµ¤èº«è‚‰/ã‚ã•ã‚Š/å°æ¾èœã€ãƒ“ã‚¿ãƒŸãƒ³Cã‚‚ä¸€ç·’ã«",
          "ç”˜ã„é£²ã¿ç‰©ã®ä»£ã‚ã‚Šã«ç„¡ç³–ãƒ©ãƒ†/ãŠèŒ¶/ç‚­é…¸æ°´"
        ];
      }

      if(g.id === "habit"){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œ80ç‚¹ã§OKãƒ«ãƒ¼ãƒ«ã€ã§æ±ºã‚æ‰“ã¡ã«ã™ã‚‹ã€‚";
        menu = [
          "å›ºå®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œã‚‹ï¼šä¾‹ï¼‰æœï¼ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ï¼‹æœç‰©ï¼‹å‘³å™Œæ±",
          "å¤–é£Ÿã®æ—¥ã¯â€œ1ã¤ã ã‘â€èª¿æ•´ï¼ˆã”ã¯ã‚“å°‘ãªã‚ç­‰ï¼‰",
          "å®Œç’§ã‚ˆã‚Šç¶™ç¶šï¼šé€±å˜ä½ã§æ•´ãˆã‚Œã°å¤§ä¸ˆå¤«"
        ];
      }

      if(issue.includes("é–“é£Ÿ")){
        menu.unshift("é–“é£Ÿã¯â€œãŸã‚“ã±ãè³ªç³»â€ã‚’å…ˆã«ï¼šã‚†ã§åµ/ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ/ãƒãƒ¼ã‚º");
      }
      if(issue.includes("å¤–é£Ÿ")){
        menu.unshift("å¤–é£Ÿã¯ã€Œä¸»èœï¼ˆè‚‰/é­šï¼‰ï¼‹æ±ç‰©ã€å„ªå…ˆã€ä¸¼/éººã¯é »åº¦ã‚’ä¸‹ã’ã‚‹");
      }
      if(issue.includes("æ™‚é–“")){
        menu.unshift("æ™‚é–“ãŒãªã„æ—¥ã¯ã€Œå›ºå®šã‚»ãƒƒãƒˆã€ã‚’ç”¨æ„ï¼šãŠã«ãã‚Šï¼‹ã‚µãƒ©ãƒ€ãƒã‚­ãƒ³ï¼‹ã‚«ãƒƒãƒˆé‡èœ");
      }

      if(portion > 1.05 && (g.id === "cut" || g.id === "shape")){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œä¸»é£Ÿã‚’å°‘ã—ã ã‘æ¸›ã‚‰ã—ã¦ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’è¶³ã™ã€‚";
      }
      if(portion < 0.95 && g.id === "gain"){
        next = "æ¬¡ã®é£Ÿäº‹ã¯ã€Œä¸»é£Ÿã‚’1ã¤å¢—ã‚„ã™ï¼ˆãŠã«ãã‚Šç­‰ï¼‰ã€ã‚’è¿½åŠ ã€‚";
      }

      return { good, next: [next], menu };
    }

    function setList(sel, arr){
      const ul = $(sel);
      ul.innerHTML = "";
      arr.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });
    }

    function renderAll(){
      renderGoals();
      renderThumb();
      renderKpis();
      renderSegButtons("#mealSeg","meal");
      renderSegButtons("#issueSeg","issue");
      $("#portion").value = String(state.portion || 1);
      $("#mealText").value = state.mealText || "";
      $("#quickMenu").value = state.quickMenu || "";
      renderLog();
    }

    function bindEvents(){
      $("#mealSeg").addEventListener("click", (e) => {
        const b = e.target.closest("button");
        if(!b) return;
        state.mealTime = b.dataset.meal;
        renderAll(); saveStorage();
      });

      $("#issueSeg").addEventListener("click", (e) => {
        const b = e.target.closest("button");
        if(!b) return;
        const val = b.dataset.issue;
        state.issue = (state.issue === val) ? null : val;
        renderAll(); saveStorage();
      });

      $("#portion").addEventListener("change", (e) => {
        state.portion = Number(e.target.value);
        renderAll(); saveStorage();
      });

      $("#mealText").addEventListener("input", (e) => {
        state.mealText = e.target.value;
        saveStorage();
      });

      $("#quickMenu").addEventListener("change", (e) => {
        state.quickMenu = e.target.value;
        if(state.quickMenu && !state.mealText){
          state.mealText = state.quickMenu;
          $("#mealText").value = state.mealText;
        }
        saveStorage();
        renderAll();
      });

      $("#photo").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          state.photoDataUrl = reader.result;
          saveStorage();
          renderAll();
        };
        reader.readAsDataURL(file);
      });

      $("#saveBtn").addEventListener("click", () => {
        if(!state.goalId){
          alert("å…ˆã«ç›®æ¨™ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }
        const g = goalById(state.goalId);
        const now = new Date();
        const time = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
        const summary = niceMealSummary();

        state.logs.push({
          time,
          mealTime: state.mealTime,
          summary,
          goalTitle: g.title
        });

        saveStorage();
        renderAll();
        $("#hintText").textContent = "è¨˜éŒ²ã§ãã¾ã—ãŸã€‚æ¬¡ã¯ã€Œä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã‚’ä½œã‚‹ã ã‘ã€‚";
      });

      $("#advBtn").addEventListener("click", () => {
        if(!state.goalId){
          alert("å…ˆã«ç›®æ¨™ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }
        const adv = buildAdvice();

        setList("#goodList", adv.good);
        setList("#nextList", adv.next);
        setList("#menuList", adv.menu);

        $("#advStatus").textContent = "ç”Ÿæˆæ¸ˆã¿";
        $("#advDot").style.background = "var(--ok)";
        $("#hintText").textContent = "OKã€‚æ¬¡ã®é£Ÿäº‹ã§â€œã‚„ã‚‹ã“ã¨1ã¤â€ã ã‘å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚";
      });

      $("#resetBtn").addEventListener("click", () => {
        if(!confirm("å…¥åŠ›ã¨ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;

        localStorage.removeItem(STORAGE_KEY);
        state.goalId = null;
        state.mealTime = "æœ";
        state.portion = 1;
        state.issue = null;
        state.mealText = "";
        state.quickMenu = "";
        state.photoDataUrl = null;
        state.logs = [];

        $("#advStatus").textContent = "æœªç”Ÿæˆ";
        $("#advDot").style.background = "var(--warn)";
        setList("#goodList", ["ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"]);
        setList("#nextList", ["ç›®æ¨™ã‚’é¸ã‚“ã§ã€Œä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚"]);
        setList("#menuList", ["ææ¡ˆãŒã“ã“ã«å‡ºã¾ã™ã€‚"]);

        renderAll();
        $("#hintText").textContent = "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ç›®æ¨™ã‚’é¸ã¶ã¨ã“ã‚ã‹ã‚‰ã©ã†ãã€‚";
      });
    }

    setTodayChip();
    loadStorage();
    bindEvents();
    renderAll();
  </script>
</body>
</html>
